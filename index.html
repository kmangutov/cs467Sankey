<!DOCTYPE html>
<meta charset="utf-8">
<title>SANKEY Experiment</title>
<style>

.node rect {
  cursor: move;
  fill-opacity: .9;
  shape-rendering: crispEdges;
}

.node text {
  pointer-events: none;
  text-shadow: 0 1px 0 #fff;
}

.link {
  fill: none;
  stroke: #000;
  stroke-opacity: .2;
}

.link:hover {
  stroke-opacity: .5;
}

#filters > li {
  list-style-type: none;
}

.bar:hover {
  fill: brown;
}

.axis {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.bg-div {
  background-color: white !important;
  padding: 5px !important;
  border-style: solid !important;
  border-color: #999 !important;
  border-width: 1px !important;
  margin: 5px !important;
}

body {
  font-family: 'Cantarell', sans-serif !important;
  background-color: #e3e4e5 !important;
}

label {
  font-weight: 400 !important;
  font-color: #212121;
}

ul {
  margin-left: 0px !important;
  padding-left: 0px !important;
}

.nopadding {
   padding: 0 !important;
   margin: 0 !important;
}

</style>
<link href='https://fonts.googleapis.com/css?family=Cantarell' rel='stylesheet' type='text/css'>
<body  onload="barChart()">
<div class="containter">
  <div class="row">
    <div class="col-md-3 nopadding">
      <br><br>
      <div class="bg-div"><p id="bars"></p></div>
    </div>
    <div class="col-md-6 nopadding">
      <br><br>
      <div class="bg-div"><div style="overflow:scroll; height:700px"><p id="chart"></p></div></div>
    </div>
    <div class="col-md-3 nopadding">
      <br><br>
      <div class="bg-div"><h4>Academic Field</h4>
      <ul id="filters">



        <li>
          <input type="checkbox" value="Bioinformatics & Computational Biology" id="a"><label for="a">Bioinformatics & Computational Biology</label>
        </li>

        <li>
          <input type="checkbox" value="Data Mining" id="b"><label for="b">Data Mining</label>
        </li>

        <li>
          <input type="checkbox" value="Machine Learning & Pattern Recognition" id="c"><label for="c">Machine Learning & Pattern Recognition</label>
        </li>

        <li>
          <input type="checkbox" value="Scientific Computing" id="d"><label for="d">Scientific Computing</label>
        </li>

        <li>
          <input type="checkbox" value="Security & Privacy" id="e"><label for="e">Security & Privacy</label>
        </li>

        <li>
          <input type="checkbox" value="" id="f"><label for="f">Human-Computer Interaction</label>
        </li>

        <li>
          <input type="checkbox" value="Algorithms & Theory" id="g"><label for="g">Algorithms & Theory</label>
        </li>

        <li>
          <input type="checkbox" value="Computer Education" id="h"><label for="h">Computer Education</label>
        </li>

        <li>
          <input type="checkbox" value="Distributed & Parallel Computing" id="i"><label for="i">Distributed & Parallel Computing</label>
        </li>

        <li>
          <input type="checkbox" value="" id="j"><label for="j">Real-Time & Embedded Systems</label>
        </li>

        <li>
          <input type="checkbox" value="Programming Languages" id="k"><label for="k">Programming Languages</label>
        </li>

        <li>
          <input type="checkbox" value="Artificial Intelligence" id="a"><label for="l">Artificial Intelligence</label>
        </li>

        <li>
          <input type="checkbox" value="Information Retrieval" id="m"><label for="m">Information Retrieval</label>
        </li>

        <li>
          <input type="checkbox" value="Networks & Communications" id="n"><label for="n">Networks & Communications</label>
        </li>

        <li>
          <input type="checkbox" value="Hardware & Architecture" id="o"><label for="o">Hardware & Architecture</label>
        </li>

        <li>
          <input type="checkbox" value="Operating Systems" id="p"><label for="p">Operating Systems</label>
        </li>

        <li>
          <input type="checkbox" value="Software Engineering" id="q"><label for="q">Software Engineering</label>
        </li>


        <li>
          <input type="checkbox" value="Computer Vision" id="r"><label for="r">Computer Vision</label>
        </li>


        <li>
          <input type="checkbox" value="Multimedia" id="s"><label for="s">Multimedia</label>
        </li>


        <li>
          <input type="checkbox" value="Natural Language & Speech" id="t"><label for="t">Natural Language & Speech</label>
        </li>


        <li>
          <input type="checkbox" value="Databases" id="u"><label for="u">Databases</label>
        </li>


        <li>
          <input type="checkbox" value="Graphics" id="v"><label for="v">Graphics</label>
        </li>

      </ul>

    </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.3.min.js"
        integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="
        crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="sankey.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script>
  
Array.prototype.contains = function(obj) {
    var i = this.length;
    while (i--) {
        if (this[i] == obj) {
            return true;
        }
    }
    return false;
}

var units = "Widgets";

var margin = {top: 10, right: 10, bottom: 10, left: 10},
    width = 600 - margin.left - margin.right,
    height = 5000 - margin.top - margin.bottom;

var formatNumber = d3.format(",.0f"),    // zero decimal places
    format = function(d) { return formatNumber(d) + " " + units; },
    color = d3.scale.category20();

// append the svg canvas to the page
var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", 
          "translate(" + margin.left + "," + margin.top + ")");

// Set the sankey diagram properties
var sankey = d3.sankey()
    .nodeWidth(36)
    .nodePadding(40)
    .size([width, height]);

var path = sankey.link();

// load the data (using the timelyportfolio csv method)

$("#filters :checkbox").click(function() {

  var filters = [];
  $("#filters :checkbox:checked").each(function() {
     filters.push($(this).val());
  });
  console.log(JSON.stringify(filters));
  renderWithFilter(filters);
});



var renderWithFilter = function(filters) {
  $("#chart").empty();
  svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", 
          "translate(" + margin.left + "," + margin.top + ")");


  // Set the sankey diagram properties
  sankey = d3.sankey()
      .nodeWidth(36)
      .nodePadding(40)
      .size([width, height]);

  path = sankey.link();




  d3.csv("prof_data.csv", function(error, data) {

    //set up graph in same style as original example but empty
    graph = {"nodes" : [], "links" : []};
    var fields = []

      data.forEach(function (d) {

        //console.log(JSON.stringify(d));

        var sourceSplit = d.source.split("_");
        var sourceName = sourceSplit[0] + sourceSplit[2];

        var targetSplit = d.target.split("_");
        var targetName = targetSplit[0] + targetSplit[2];

        var field = targetSplit[1];
        if(!fields.contains(field)) {
          fields.push(field);
          console.log(JSON.stringify(fields));
        }

        if(!filters.contains(sourceSplit[1]))
          return;

        /*graph.nodes.push({ "name": d.source });
        graph.nodes.push({ "name": d.target });
        graph.links.push({ "source": d.source,
                           "target": d.target,
                           "value": +d.value });*/

        var val = 0;
        var newLinks = [];
        graph.links.forEach(function(d) {
          if(d.source == sourceName && d.target == targetName) {
            val += parseInt(d.value);
          }
          else {
            newLinks.push(d);
          }
        });

        graph.links = newLinks;


        graph.nodes.push({ "name": sourceName });
        graph.nodes.push({ "name": targetName });
        graph.links.push({ "source": sourceName,
                           "target": targetName,
                           "value": + val + parseInt(d.value) });


        console.log(JSON.stringify(graph.links));
      });

       // return only the distinct / unique nodes
       graph.nodes = d3.keys(d3.nest()
         .key(function (d) { return d.name; })
         .map(graph.nodes));

       // loop through each link replacing the text with its index from node
       graph.links.forEach(function (d, i) {
         graph.links[i].source = graph.nodes.indexOf(graph.links[i].source);
         graph.links[i].target = graph.nodes.indexOf(graph.links[i].target);
       });

       //now loop through each nodes to make nodes an array of objects
       // rather than an array of strings
       graph.nodes.forEach(function (d, i) {
         graph.nodes[i] = { "name": d };
       });

    sankey
      .nodes(graph.nodes)
      .links(graph.links)
      .layout(32);

  // add in the links
    var link = svg.append("g").selectAll(".link")
        .data(graph.links)
      .enter().append("path")
        .attr("class", "link")
        .attr("d", path)
        .style("stroke-width", function(d) { return Math.max(1, d.dy); })
        .sort(function(a, b) { return b.dy - a.dy; });

  // add the link titles
    link.append("title")
          .text(function(d) {
          return d.source.name + " â†’ " + 
                  d.target.name + "\n" + format(d.value); });

  // add in the nodes
    var node = svg.append("g").selectAll(".node")
        .data(graph.nodes)
      .enter().append("g")
        .attr("class", "node")
        .attr("transform", function(d) { 
        return "translate(" + d.x + "," + d.y + ")"; })
      .call(d3.behavior.drag()
        .origin(function(d) { return d; })
        .on("dragstart", function() { 
        this.parentNode.appendChild(this); })
        .on("drag", dragmove));

  // add the rectangles for the nodes
    node.append("rect")
        .attr("height", function(d) { return d.dy; })
        .attr("width", sankey.nodeWidth())
        .style("fill", function(d) { 
        return d.color = color(d.name.replace(/ .*/, "")); })
        //.style("stroke", function(d) { 
        //return d3.rgb(216,216,216) })
      .append("title")
        .text(function(d) { 
        return d.name + "\n" + format(d.value); });

  // add in the title for the nodes
    node.append("text")
        .attr("x", -6)
        .attr("y", function(d) { return d.dy / 2; })
        .attr("dy", ".35em")
        .attr("text-anchor", "end")
        .attr("transform", null)
        .text(
          function(d) { 
            var name = d.name.substring(1, d.name.length);
            name = name.replace("University", "");
            name = name.replace("of", "");
            name = name.replace("State", "");
            name = name.trim();
            return name;
          })
      .filter(function(d) { return d.x < width / 2; })
        .attr("x", 6 + sankey.nodeWidth())
        .attr("text-anchor", "start");

  // the function for moving the nodes
    function dragmove(d) {
      d3.select(this).attr("transform", 
          "translate(" + d.x + "," + (
                  d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))
              ) + ")");
      sankey.relayout();
      link.attr("d", path);
    }
  });
}


renderWithFilter([]);


function barChart(){

  var bwidth = 250;
  var bheight = 400;

  margin.top = 50;
  margin.bottom = 50;


  var dat = [{field: "AI", count: 10}, {field: "HCI", count: 5}, {field: "Distributed", count: 15}];

  var x = d3.scale.ordinal()
      .rangeRoundBands([0, bwidth], .8);

  var y = d3.scale.linear()
      .range([bheight, 0]);

  var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom");

  var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left")
      .ticks(7);

  var svg = d3.select("#bars").append("svg:svg")
              .attr("width", bwidth)
              .attr("height", bheight)
              .append("svg:g")
              .attr("transform", "translate(" + (margin.left+30) + "," + (-margin.bottom-10) + ")");

  x.domain(dat.map(function(d){return d.field}));
  y.domain([0, d3.max(dat, function(d) { return d.count; })]);

  svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + (bheight) + ")")
        .call(xAxis)
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", "-.55em")
        .attr("transform", "rotate(-75)" );

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Total Number");

      //x-axis label
    svg.append("text")      
      .attr("x", bwidth - 50)
      .attr("y",  bheight )
      .style("text-anchor", "middle")
      .attr("class", "axis")
      .text("Field");

    svg.selectAll(".bar")
      .data(dat)
    .enter().append("rect")
      .style("fill", function(d,i) { return color(i)})
      .attr("class", "bar")
      .attr("x", function(d) { return x(d.field); })
      .attr("width", 20)
      .attr("y", function(d) { return y(d.count); })
      .attr("height", function(d) { return bheight - y(d.count); });
}

</script>

</body>
</html>
